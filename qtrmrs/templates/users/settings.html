{% extends 'base.html' %}

{% block content %}
<div style="max-width: 700px; margin: 0 auto; padding-top: 40px;">

    <div x-data="{ editing: false }">

        <div class="settings-header">
            <h1>Account Settings</h1>

            <button @click="editing = !editing" class="btn btn-tonal">
                <span class="material-symbols-outlined" x-text="editing ? 'close' : 'edit'">edit</span>
                <span x-text="editing ? 'Cancel' : 'Edit Profile'">Edit Profile</span>
            </button>
        </div>

        {% if messages %}
        {% for message in messages %}
        <div
            style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); color: var(--color-primary); padding: 12px; border-radius: 8px; margin-bottom: 24px;">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}

        <div x-show="!editing" x-transition class="card">

            <div class="profile-row">
                <div class="avatar-circle">
                    {% if user.avatar %}
                    <img src="{{ user.avatar.url }}" alt="Avatar">
                    {% else %}
                    <span style="font-size: 2rem; font-weight: 700; color: var(--color-primary);">{{
                        user.username.0|upper }}</span>
                    {% endif %}
                </div>
                <div>
                    <h2 style="margin: 0; font-size: 1.5rem;">{{ user.username }}</h2>
                    <p style="margin: 0; color: var(--color-text-muted);">Student</p>
                </div>
            </div>

            <div class="info-row">
                <label>Username</label>
                <div class="info-value">{{ user.username }}</div>
            </div>

            <div class="info-row">
                <label>Email Address</label>
                <div class="info-value">{{ user.email }}</div>
            </div>

            <div class="info-row" style="border-bottom: none;">
                <label>Password</label>
                <div class="info-value">••••••••••••••••</div>
            </div>

        </div>

        <div x-show="editing" x-cloak style="display: none;">

            <div class="card" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 20px;">Update Info</h3>
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--color-text-muted);">Profile
                            Picture</label>
                        {{ profile_form.avatar }}
                    </div>

                    <div class="form-grid">
                        <div style="margin-bottom: 20px; grid-column: span 2;">
                            <label class="field-label">Username</label>
                            {{ profile_form.username }}
                        </div>
                    </div>

                    <div style="text-align: right;">
                        <button type="submit" name="update_profile" class="btn btn-filled">Save Changes</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px; color: var(--color-error);">Security</h3>
                <form method="POST">
                    {% csrf_token %}

                    {% for field in password_form %}
                    <div style="margin-bottom: 16px;">
                        <label class="field-label">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                        <div style="color: var(--color-error); font-size: 0.85rem;">{{ field.errors.0 }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}

                    <div style="text-align: right;">
                        <button type="submit" name="change_password" class="btn btn-tonal"
                            style="color: var(--color-error);">Update Password</button>
                    </div>
                </form>
            </div>

        </div>

    </div>
</div>

<style>
    /* Header Layout */
    .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        gap: 20px;
        flex-wrap: wrap;
    }

    .settings-header h1 {
        margin: 0;
        line-height: 1;
    }

    /* Avatar Styling */
    .profile-row {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--color-border);
    }

    .avatar-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--color-surface-variant);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border: 2px solid var(--color-border);
        flex-shrink: 0;
    }

    .avatar-circle img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Read-Only Rows */
    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        border-bottom: 1px solid var(--color-border);
    }

    .info-row label {
        color: var(--color-text-muted);
        font-weight: 500;
    }

    .info-value {
        font-weight: 600;
        color: var(--color-text-main);
    }

    /* Form Styling */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .field-label {
        display: block;
        margin-bottom: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--color-text-muted);
    }

    .form-input {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        background: var(--color-bg);
        color: var(--color-text-main);
        outline: none;
        font-size: 1rem;
    }

    .form-input:focus {
        border-color: var(--color-primary);
    }

    input[type="file"] {
        color: var(--color-text-muted);
    }

    [x-cloak] {
        display: none !important;
    }

    @media (max-width: 600px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}