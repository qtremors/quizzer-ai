{% extends 'base.html' %}

{% block content %}
<div style="max-width: 1600px; margin: 0 auto; padding: 40px 24px; width: 100%;">

    <div class="dashboard-header">
        <div>
            <h1 style="margin-bottom: 8px; font-size: 3rem;">Dashboard</h1>
            <p style="color: var(--color-text-muted); font-size: 1.2rem;">Welcome back, {{ user.username }}</p>
        </div>

        <div class="stats-row">
            <!-- Level & XP -->
            <div class="stat-card level-card">
                <span class="stat-label">Level</span>
                <span class="stat-value">{{ profile.level }}</span>
                <div class="xp-bar-mini">
                    <div class="xp-progress-mini" style="width: {{ profile.xp_progress_percent }}%;"></div>
                </div>
                <span style="font-size: 0.75rem; color: var(--color-text-muted);">{{ profile.xp }} XP</span>
            </div>

            <!-- Streak -->
            <div class="stat-card">
                <span class="stat-label">Streak</span>
                <span class="stat-value">ðŸ”¥ {{ profile.current_streak }}</span>
            </div>

            <div class="stat-card">
                <span class="stat-label">Total Quizzes</span>
                <span class="stat-value">{{ total_quizzes }}</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Average Score</span>
                <span class="stat-value" style="color: var(--color-primary);">{{ avg_score }}%</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Best Score</span>
                <span class="stat-value" style="color: var(--color-success);">{{ profile.best_score }}%</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Correct Answers</span>
                <span class="stat-value">{{ profile.total_correct_answers }}</span>
            </div>
            {% if incomplete_count > 0 %}
            <div class="stat-card" style="border-color: rgba(245, 158, 11, 0.3);">
                <span class="stat-label">In Progress</span>
                <span class="stat-value" style="color: var(--color-warning);">{{ incomplete_count }}</span>
            </div>
            {% endif %}
        </div>

        {% if badges %}
        <div class="badges-row">
            {% for ub in badges %}
            <div class="badge-item" title="{{ ub.badge.description }}">
                <span class="badge-icon">{{ ub.badge.icon }}</span>
                <span class="badge-name">{{ ub.badge.name }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div
        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; padding-bottom: 16px; border-bottom: 1px solid var(--color-border);">
        <h3 style="margin: 0; font-size: 1.5rem; color: var(--color-text-main);">Recent Activity</h3>
        <a href="{% url 'quiz_setup' %}" class="btn btn-text" style="font-size: 0.9rem;">
            <span class="material-symbols-outlined" style="font-size: 18px;">add</span> New Quiz
        </a>
    </div>

    {% if quizzes %}
    <div class="quiz-grid">
        {% for quiz in quizzes %}
        <div class="history-card {% if not quiz.is_complete %}card-incomplete{% endif %}">

            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <div>
                    <span class="topic-tag">{{ quiz.topic_description|truncatechars:25 }}</span>
                    <div style="font-size: 0.85rem; color: var(--color-text-muted); margin-top: 6px;">
                        {{ quiz.created_at|date:"M d, Y" }}
                    </div>
                </div>

                {% if quiz.is_complete %}
                <!-- Completed Quiz - Show Score -->
                <div class="score-badge" style="
                        background: {% if quiz.score >= 80 %}rgba(16,185,129,0.1); color: var(--color-success); border: 1px solid rgba(16,185,129,0.2);
                        {% elif quiz.score >= 50 %}rgba(245,158,11,0.1); color: var(--color-warning); border: 1px solid rgba(245,158,11,0.2);
                        {% else %}rgba(239,68,68,0.1); color: var(--color-error); border: 1px solid rgba(239,68,68,0.2);{% endif %}
                    ">
                    {{ quiz.score }}%
                </div>
                {% else %}
                <!-- Incomplete Quiz - Show Progress -->
                <div class="incomplete-indicator">
                    <span class="dot"></span>
                    {{ quiz.answered_count }}/{{ quiz.total_questions }} answered
                </div>
                {% endif %}
            </div>

            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: auto;">
                <div class="meta-item">
                    <span class="material-symbols-outlined">signal_cellular_alt</span>
                    {{ quiz.difficulty|title }}
                </div>

                {% if quiz.is_complete %}
                <!-- Completed Quiz Actions -->
                <div style="display: flex; gap: 8px; align-items: center;">
                    <form action="{% url 'retry_quiz' quiz.id %}" method="POST" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="action-btn retry" title="Retry Quiz">
                            <span class="material-symbols-outlined">replay</span>
                        </button>
                    </form>
                    <form action="{% url 'delete_quiz' quiz.id %}" method="POST" style="display: inline;"
                        onsubmit="return confirm('Delete this quiz? This cannot be undone.');">
                        {% csrf_token %}
                        <button type="submit" class="action-btn delete" title="Delete Quiz">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </form>
                    <a href="{% url 'quiz_results' quiz.id %}" class="view-btn">
                        View Details <span class="material-symbols-outlined"
                            style="font-size: 16px;">arrow_forward</span>
                    </a>
                </div>
                {% else %}
                <!-- Incomplete Quiz - Continue Button -->
                <a href="{% url 'quiz_player' quiz.id %}" class="continue-btn">
                    <span class="material-symbols-outlined" style="font-size: 18px;">play_arrow</span>
                    Continue
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav
        style="display: flex; justify-content: center; align-items: center; gap: 16px; margin-top: 40px; padding-top: 24px; border-top: 1px solid var(--color-border);">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-tonal" style="gap: 8px;">
            <span class="material-symbols-outlined" style="font-size: 18px;">chevron_left</span>
            Previous
        </a>
        {% endif %}

        <span style="color: var(--color-text-muted);">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="btn btn-tonal" style="gap: 8px;">
            Next
            <span class="material-symbols-outlined" style="font-size: 18px;">chevron_right</span>
        </a>
        {% endif %}
    </nav>
    {% endif %}

    {% else %}
    <div
        style="text-align: center; padding: 80px; border: 1px dashed var(--color-border); border-radius: 16px; background: var(--color-surface);">
        <div
            style="background: var(--color-surface-variant); width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px auto;">
            <span class="material-symbols-outlined" style="font-size: 32px; color: var(--color-text-muted);">quiz</span>
        </div>
        <h3 style="margin-bottom: 8px;">No quizzes yet</h3>
        <p style="color: var(--color-text-muted); margin-bottom: 32px;">Create your first AI-generated quiz to start
            tracking progress.</p>
        <a href="{% url 'quiz_setup' %}" class="btn btn-filled">Start Quiz</a>
    </div>
    {% endif %}

</div>

<style>
    /* Header Layout */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        flex-wrap: wrap;
        gap: 32px;
        margin-bottom: 60px;
    }

    .stats-row {
        display: flex;
        gap: 24px;
    }

    .badges-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 16px;
    }

    .badge-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 20px;
        font-size: 0.85rem;
        cursor: help;
    }

    .badge-icon {
        font-size: 1.2rem;
    }

    .badge-name {
        color: var(--color-text-main);
        font-weight: 500;
    }

    .stat-card {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        padding: 16px 32px;
        border-radius: 16px;
        text-align: center;
        min-width: 140px;
    }

    .stat-label {
        display: block;
        font-size: 0.85rem;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
    }

    /* THE GRID SYSTEM */
    .quiz-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 24px;
    }

    /* Card Styling */
    .history-card {
        display: flex;
        flex-direction: column;
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        padding: 24px;
        border-radius: 16px;
        text-decoration: none;
        transition: all 0.2s ease;
        min-height: 180px;
    }

    .history-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-hover);
    }

    /* Incomplete card animation */
    .card-incomplete {
        border-color: rgba(245, 158, 11, 0.3);
        animation: breathe 2s ease-in-out infinite;
    }

    .card-incomplete:hover {
        border-color: var(--color-warning);
    }

    @keyframes breathe {

        0%,
        100% {
            box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
        }

        50% {
            box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.1);
        }
    }

    /* Incomplete indicator */
    .incomplete-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--color-warning);
        padding: 4px 10px;
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.2);
        border-radius: 20px;
    }

    .incomplete-indicator .dot {
        width: 8px;
        height: 8px;
        background: var(--color-warning);
        border-radius: 50%;
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.5;
            transform: scale(1.2);
        }
    }

    .topic-tag {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--color-text-main);
        text-transform: capitalize;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--color-text-muted);
        font-size: 0.9rem;
        background: var(--color-surface-variant);
        padding: 4px 10px;
        border-radius: 6px;
    }

    .meta-item .material-symbols-outlined {
        font-size: 18px;
    }

    .score-badge {
        padding: 6px 12px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.95rem;
    }

    .view-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--color-primary);
        text-decoration: none;
    }

    .view-btn:hover {
        text-decoration: underline;
    }

    /* Continue Button for incomplete quizzes */
    .continue-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
        font-weight: 600;
        color: white;
        background: var(--color-warning);
        padding: 8px 16px;
        border-radius: 20px;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .continue-btn:hover {
        background: #d97706;
        transform: scale(1.05);
    }

    /* Action buttons */
    .action-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid var(--color-border);
        background: var(--color-surface);
        color: var(--color-text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .action-btn .material-symbols-outlined {
        font-size: 18px;
    }

    .action-btn.retry:hover {
        background: var(--color-primary-container);
        border-color: var(--color-primary);
        color: var(--color-primary);
    }

    .action-btn.delete:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--color-error);
        color: var(--color-error);
    }

    @media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            align-items: stretch;
        }

        .stats-row {
            justify-content: center;
        }

        .quiz-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Level Card & XP Bar Mini */
    .level-card {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.05), rgba(139, 92, 246, 0.05));
    }

    .xp-bar-mini {
        width: 100%;
        height: 6px;
        background: var(--color-surface-variant);
        border-radius: 3px;
        overflow: hidden;
        margin: 8px 0 4px 0;
    }

    .xp-progress-mini {
        height: 100%;
        background: linear-gradient(90deg, #fbbf24, #f59e0b);
        border-radius: 3px;
        transition: width 0.5s ease;
    }
</style>
{% endblock %}